; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Win32 OpenGL 4.6 Example.                                                                             --
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Assembler directives (NASM)                                                                           --
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

default                             rel

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; General Includes                                                                                      --
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

%include                            "Macros.i"
%include                            "Externals.i"
%include                            "WinConst.i"

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Readonly data section                                                                                 --
;                                                                                                       --
section                             .rdata
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Data section                                                                                          --
;                                                                                                       --
section                             .data
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Unitialized data section                                                                              --
;                                                                                                       --
section                             .bss
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Code section                                                                                          --
;                                                                                                       --
section                             .code
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Code includes                                                                                         --
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

%include                            "Window.i"
%include                            "OpenGL.i"

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Code                                                                                                  --
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

; --------------------------------------------------------------------------------------------------------
;                                                                                                       --
; Main entry point                                                                                      --
;                                                                                                       --
; --------------------------------------------------------------------------------------------------------

;
;                                   Function:           Main
;                                   Description:        The main entry point for the program.
;
;                                   Parameters:         None
;
;                                   Returns:            0 if successful.
;
function                            Main

                                    ; ------------- [Setup stack frame] ----------------------------------

                                    push            rbp
                                    mov             rbp, rsp
                                    sub             rsp, 32

                                    ; ------------- [Setup main window] ----------------------------------

                                    call            SetupMainWindow

                                    ; ------------- [Load OpenGL functions] ------------------------------

                                    call            LoadGL

                                    ; ------------- [Set the clear color] --------------------------------

                                    mov             rcx, __float32__(0.1)
                                    mov             rdx, __float32__(0.15)
                                    mov             r8, __float32__(1.0)
                                    movq            xmm0, rcx
                                    movq            xmm1, rcx
                                    movq            xmm2, rdx
                                    movq            xmm3, r8
                                    call            glClearColor

.MainLoop:

                                    ; ------------- [Clear the screen] -----------------------------------

                                    mov             rcx, GL_COLOR_BUFFER_BIT
                                    call            glClear

                                    ; ------------- [Draw a colorful triangle] ---------------------------

                                    mov             rcx, GL_TRIANGLES
                                    call            glBegin

                                    ; ------------- [Vertex 1] -------------------------------------------

                                    ;               glColor3f(1.0, 0.0, 0.0)
                                    mov             rcx, __float32__(1.0)
                                    mov             rdx, __float32__(0.0)
                                    movq            xmm0, rcx
                                    movq            xmm1, rdx
                                    movq            xmm2, rdx
                                    call            glColor3f

                                    ;               glVertex2f(-0.5, -0.5)
                                    mov             rcx, __float32__(-0.5)
                                    movq            xmm0, rcx
                                    movq            xmm1, rcx
                                    call            glVertex2f

                                    ; ------------- [Vertex 2] -------------------------------------------

                                    ;               glColor3f(0.0, 1.0, 0.0)
                                    mov             rcx, __float32__(1.0)
                                    mov             rdx, __float32__(0.0)
                                    movq            xmm0, rdx
                                    movq            xmm1, rcx
                                    movq            xmm2, rdx
                                    call            glColor3f

                                    ;               glVertex2f(0.0, 0.5)
                                    mov             rcx, __float32__( 0.0)
                                    mov             rdx, __float32__( 0.5)
                                    movq            xmm0, rcx
                                    movq            xmm1, rdx
                                    call            glVertex2f

                                    ; ------------- [Vertex 3] -------------------------------------------

                                    ;               glColor3f(0.0, 0.0, 1.0)
                                    mov             rcx, __float32__(1.0)
                                    mov             rdx, __float32__(0.0)
                                    movq            xmm0, rdx
                                    movq            xmm1, rdx
                                    movq            xmm2, rcx
                                    call            glColor3f

                                    ;               glVertex2f(0.5, -0.5)
                                    mov             rcx, __float32__( 0.5)
                                    mov             rdx, __float32__(-0.5)
                                    movq            xmm0, rcx
                                    movq            xmm1, rdx
                                    call            glVertex2f

                                    ; ------------- [End of drawing] -------------------------------------

                                    call            glEnd

                                    ; ------------- [Update main window] ---------------------------------

                                    call            UpdateMainWindow

                                    ; ------------- [Check if the window is still open] ------------------

                                    call            IsMainWindowOpen

                                    ; ------------- [Keep running if the main window is still open] ------

                                    test            rax, rax
                                    jnz             .MainLoop

                                    ; ------------- [Exit process successfully] --------------------------

                                    xor             rcx, rcx
                                    call            ExitProcess